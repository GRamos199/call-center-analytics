# =============================================================================
# GitHub Pages - Dashboard Screenshots & Documentation
# Generates screenshots of the Streamlit dashboard and publishes to Pages
# =============================================================================

name: üìÑ GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'analytics/**'
      - '.github/workflows/pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Generate Screenshots
  # ===========================================================================
  screenshots:
    name: üì∏ Generate Screenshots
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: ÔøΩÔøΩ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üé≠ Install Playwright
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: üöÄ Start Streamlit app
        run: |
          cd analytics && streamlit run app.py --server.port 8501 --server.headless true &
          echo "Waiting for Streamlit to start..."
          sleep 15
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:8501/_stcore/health || exit 1
          echo "‚úÖ Streamlit is running"

      - name: üì∏ Take screenshots
        run: |
          mkdir -p docs/screenshots
          
          python << 'SCREENSHOT_SCRIPT'
          import asyncio
          from playwright.async_api import async_playwright
          import time

          async def take_screenshots():
              async with async_playwright() as p:
                  browser = await p.chromium.launch()
                  context = await browser.new_context(
                      viewport={'width': 1920, 'height': 1080},
                      device_scale_factor=2
                  )
                  page = await context.new_page()
                  
                  base_url = "http://localhost:8501"
                  
                  # Screenshot 1: Welcome Page
                  print("üì∏ Taking screenshot: Welcome Page")
                  await page.goto(base_url)
                  await page.wait_for_timeout(3000)
                  await page.screenshot(path="docs/screenshots/01-welcome.png", full_page=True)
                  
                  # Click Monthly Report button
                  print("üì∏ Taking screenshot: Monthly Report")
                  try:
                      await page.click('button:has-text("Monthly Report")')
                      await page.wait_for_timeout(3000)
                      await page.screenshot(path="docs/screenshots/02-monthly-report.png", full_page=True)
                  except Exception as e:
                      print(f"Could not click Monthly Report: {e}")
                  
                  # Click Weekly Report button
                  print("üì∏ Taking screenshot: Weekly Report")
                  try:
                      await page.click('button:has-text("Weekly Report")')
                      await page.wait_for_timeout(3000)
                      await page.screenshot(path="docs/screenshots/03-weekly-report.png", full_page=True)
                  except Exception as e:
                      print(f"Could not click Weekly Report: {e}")
                  
                  await browser.close()
                  print("‚úÖ All screenshots taken!")

          asyncio.run(take_screenshots())
          SCREENSHOT_SCRIPT

      - name: üìÑ Generate PDF from screenshots
        run: |
          pip install img2pdf pillow
          
          python << 'PDF_SCRIPT'
          import img2pdf
          from PIL import Image
          import os

          screenshots_dir = "docs/screenshots"
          output_pdf = "docs/dashboard-preview.pdf"

          # Get all PNG files sorted
          images = sorted([
              os.path.join(screenshots_dir, f) 
              for f in os.listdir(screenshots_dir) 
              if f.endswith('.png')
          ])

          if images:
              # Convert to PDF
              with open(output_pdf, "wb") as f:
                  f.write(img2pdf.convert(images))
              print(f"‚úÖ PDF generated: {output_pdf}")
          else:
              print("‚ö†Ô∏è No screenshots found")
          PDF_SCRIPT

      - name: üìù Generate HTML gallery
        run: |
          cat > docs/index.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Call Center Analytics - Dashboard Preview</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                      min-height: 100vh;
                      padding: 40px 20px;
                  }
                  .container {
                      max-width: 1400px;
                      margin: 0 auto;
                  }
                  header {
                      text-align: center;
                      margin-bottom: 50px;
                  }
                  .logo { font-size: 80px; margin-bottom: 20px; }
                  h1 {
                      font-size: 42px;
                      background: linear-gradient(135deg, #3B82F6, #F63B83, #83F63B);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      margin-bottom: 15px;
                  }
                  .subtitle { color: rgba(255,255,255,0.7); font-size: 18px; margin-bottom: 30px; }
                  .actions {
                      display: flex;
                      justify-content: center;
                      gap: 20px;
                      flex-wrap: wrap;
                      margin-bottom: 50px;
                  }
                  .btn {
                      display: inline-flex;
                      align-items: center;
                      gap: 10px;
                      padding: 15px 30px;
                      border-radius: 30px;
                      text-decoration: none;
                      font-weight: 600;
                      font-size: 16px;
                      transition: all 0.3s;
                  }
                  .btn-primary {
                      background: linear-gradient(135deg, #3B82F6, #F63B83);
                      color: white;
                  }
                  .btn-secondary {
                      background: rgba(255,255,255,0.1);
                      color: white;
                      border: 2px solid rgba(255,255,255,0.3);
                  }
                  .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
                  .gallery {
                      display: grid;
                      gap: 30px;
                  }
                  .screenshot {
                      background: rgba(255,255,255,0.05);
                      border-radius: 16px;
                      overflow: hidden;
                      border: 1px solid rgba(255,255,255,0.1);
                  }
                  .screenshot-header {
                      padding: 20px;
                      background: rgba(0,0,0,0.2);
                      display: flex;
                      align-items: center;
                      gap: 15px;
                  }
                  .screenshot-header .icon { font-size: 28px; }
                  .screenshot-header h3 { color: white; font-size: 20px; }
                  .screenshot-header p { color: rgba(255,255,255,0.6); font-size: 14px; }
                  .screenshot img {
                      width: 100%;
                      height: auto;
                      display: block;
                  }
                  .note {
                      background: rgba(59, 130, 246, 0.2);
                      border: 1px solid #3B82F6;
                      border-radius: 12px;
                      padding: 20px;
                      margin-top: 50px;
                      text-align: center;
                  }
                  .note p { color: rgba(255,255,255,0.8); }
                  .note a { color: #3B82F6; }
                  footer {
                      text-align: center;
                      margin-top: 50px;
                      color: rgba(255,255,255,0.5);
                      font-size: 14px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <div class="logo">üìä</div>
                      <h1>Call Center Analytics</h1>
                      <p class="subtitle">Interactive Dashboard Preview</p>
                      <div class="actions">
                          <a href="dashboard-preview.pdf" class="btn btn-primary">
                              üìÑ Download PDF Preview
                          </a>
                          <a href="https://github.com/GRamos199/call-center-analytics" class="btn btn-secondary">
                              üìÅ View Repository
                          </a>
                      </div>
                  </header>

                  <div class="gallery">
                      <div class="screenshot">
                          <div class="screenshot-header">
                              <span class="icon">üè†</span>
                              <div>
                                  <h3>Welcome Page</h3>
                                  <p>Animated landing page with dashboard introduction</p>
                              </div>
                          </div>
                          <img src="screenshots/01-welcome.png" alt="Welcome Page">
                      </div>

                      <div class="screenshot">
                          <div class="screenshot-header">
                              <span class="icon">üìÖ</span>
                              <div>
                                  <h3>Monthly Report</h3>
                                  <p>Comprehensive monthly analytics with KPIs and trends</p>
                              </div>
                          </div>
                          <img src="screenshots/02-monthly-report.png" alt="Monthly Report">
                      </div>

                      <div class="screenshot">
                          <div class="screenshot-header">
                              <span class="icon">üìÜ</span>
                              <div>
                                  <h3>Weekly Report</h3>
                                  <p>Detailed weekly performance metrics and comparisons</p>
                              </div>
                          </div>
                          <img src="screenshots/03-weekly-report.png" alt="Weekly Report">
                      </div>
                  </div>

                  <div class="note">
                      <p>
                          üí° <strong>Note:</strong> This is a static preview. 
                          To run the interactive dashboard locally, clone the repository and run:
                          <br><br>
                          <code style="background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 8px; color: #83F63B;">
                              docker-compose up
                          </code>
                      </p>
                  </div>

                  <footer>
                      <p>Generated automatically by GitHub Actions ‚Ä¢ Call Center Analytics Dashboard</p>
                  </footer>
              </div>
          </body>
          </html>
          HTML_EOF

      - name: üì§ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  # ===========================================================================
  # Deploy to GitHub Pages
  # ===========================================================================
  deploy:
    name: üöÄ Deploy to Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: screenshots

    steps:
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
